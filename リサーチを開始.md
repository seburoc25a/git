# **Microsoft Entra Cloud Sync を使用した Entra ID から AWS 上の Active Directory へのグループプロビジョニング：設定、アーキテクチャ、考慮事項**

エグゼクティブサマリー  
本レポートは、Microsoft Entra Cloud Sync を活用して、Microsoft Entra ID から Amazon Web Services (AWS) 上にホストされた Active Directory (AD) 環境へIDデータ、特にグループをプロビジョニングするための専門的なガイダンスを提供します。AWS Managed Microsoft AD および Amazon EC2 インスタンス上の自己管理型 AD Domain Services (AD DS) の両方の設定について解説します。  
主要な調査結果として、Entra Cloud Sync、特にその「Active Directory へのグループプロビジョニング」機能は、このシナリオにおいて軽量なエージェントベースのアプローチを提供する実行可能なソリューションであることが示されました。実装の成功は、AWS ネットワークアーキテクチャ（VPC、サブネット、セキュリティグループ、NACL）の綿密な計画、Cloud Sync エージェント用の EC2 インスタンスの適切なサイジングと配置、最小権限の原則に従った堅牢な IAM ロール設定、および AD の前提条件（スキーマ属性や gMSA など）の明確な理解にかかっています。

本レポートでは、具体的な設定手順、アーキテクチャパターン、同期後の AWS AD リソースへアクセスするエンドユーザーの認証フロー（特にパスワードハッシュ同期が有効な場合）、監視とトラブルシューティングを含む運用上の考慮事項、および潜在的なコストへの影響の内訳について詳述します。

戦略的な推奨事項としては、段階的な展開、オンデマンドプロビジョニングを使用した包括的なテスト、Azure と AWS の両方におけるセキュリティベストプラクティスの遵守、そして回復力のある安全なハイブリッドIDソリューションを確保するための継続的な監視を強調します。

**1\. はじめに: Entra Cloud Sync を使用した Entra ID と AWS 上の Active Directory の同期**

1.1. ハイブリッドIDのための Microsoft Entra Cloud Sync の概要  
Microsoft Entra Cloud Sync は、ハイブリッドIDの目標を達成するために設計されたサービスであり、ユーザー、グループ、連絡先を Microsoft Entra ID に同期します。これは、完全な Microsoft Entra Connect アプリケーションの代わりに、軽量な Microsoft Entra クラウドプロビジョニングエージェントを利用します。Cloud Sync は Entra Connect Sync と並行して動作させることができ、柔軟なハイブリッドシナリオを可能にします 1。  
このアーキテクチャは、Entra Cloud Sync を特定の同期ニーズに対応する最新かつ合理化されたソリューションとして位置づけています。エージェントがブリッジとして機能し、すべての同期設定がクラウドで管理されるというその構造 1 は、AWS のような IaaS プラットフォームでホストされている環境を含む、多様な環境の Active Directory フォレストへの接続に特に適しています。このアプローチは、展開を簡素化し、オンプレミス（または AWS 内）のインフラストラクチャフットプリントを削減する可能性があります。Cloud Sync エージェントの軽量な性質とクラウド管理の構成 1 は、従来の Entra Connect と比較してインフラストラクチャのフットプリントが小さく、管理が簡素化される可能性を意味し、AWS のようなクラウドホスト型 AD 環境にとって魅力的です。従来の Entra Connect は、より重要なオンプレミスサーバー（多くの場合、ローカル SQL データベースが必要 2）を必要とします。Cloud Sync のクラウドオーケストレーションによるエージェントベースのモデル 1 は、この複雑さの多くを Microsoft クラウドサービスに移行し、顧客側での展開とメンテナンスを簡素化します。これは、AWS でインフラストラクチャを管理する際の主要な利点です。

1.2. シナリオ: Entra ID グループの AWS ホスト型 Active Directory へのプロビジョニング  
Entra Cloud Sync は、Microsoft Entra ID からオンプレミスの Active Directory 環境へのグループのプロビジョニングをサポートしています 3。これは「Active Directory へのグループプロビジョニング」機能であり、クラウドセキュリティグループに関して Entra Connect Sync の非推奨となったグループ書き戻し v2 を置き換えるものです 3。  
ユーザーの主要な要件は、この機能を AWS インフラストラクチャ上で実行されている Active Directory インスタンスに拡張することです。ドキュメントでは主に「オンプレミス AD」に言及していますが、EC2 上の AD インスタンスまたは AWS Managed Microsoft AD は、Entra Cloud Sync の観点からは、顧客管理または AWS 管理の「オンプレミスのような」ディレクトリとして機能します。Entra Connect Sync のグループ書き戻し v2 の非推奨化 3 と、この機能のための Entra Cloud Sync への戦略的な移行 3 は、AWS ホスト型 AD を含むシナリオにおいて、将来を見据えたハイブリッドIDグループ管理のために Cloud Sync を理解することが重要であることを示しています。Microsoft は明らかにツールの移行を示唆しています。グループ書き戻し機能に依存している組織は、サポートを継続し、継続的な機能開発の恩恵を受けるために、セキュリティグループに対して Cloud Sync を採用する必要があります。これは、ターゲット AD が真にオンプレミスであるか、AWS のようなクラウド IaaS 環境でホストされているかにかかわらず同様に適用されます。

1.3. ターゲット AWS Active Directory 環境  
1.3.1. AWS Managed Microsoft AD  
AWS Managed Microsoft AD は、Microsoft Entra (旧 Azure AD) および Microsoft Entra Connect と互換性があります 5。これは AWS 上で完全に管理された AD サービスを提供します 6。このサービスは AD インフラストラクチャ管理を AWS にオフロードします。Entra Cloud Sync エージェントは、AWS Managed Microsoft AD にドメイン参加している別の EC2 インスタンスにインストールされます。AWS Managed Microsoft AD を使用すると、AWS 上の AD 運用負荷が簡素化されますが、Cloud Sync エージェントの展開と管理は依然として顧客の責任範囲です。エージェントの EC2 インスタンスと Managed AD エンドポイント間のネットワーク接続は非常に重要です。AWS は AD ドメインコントローラー自体（パッチ適用、可用性）を管理しますが、Cloud Sync エージェントは Microsoft のコンポーネントです。そのホスティング、OS 管理、および Entra ID と Managed AD ディレクトリの両方へのネットワークパスの確保は顧客が行います。この責任分担は計画において重要です。

\*\*1.3.2. Amazon EC2 上の自己管理型 AD DS\*\*  
顧客は EC2 インスタンス上に独自の Active Directory ドメインコントローラーを展開できます \[8, 9\]。これは AWS Managed Microsoft AD と比較してより多くの制御を提供しますが、管理オーバーヘッドも大きくなります。Cloud Sync エージェントは、専用のメンバーサーバー EC2 インスタンスにインストールすることも、EC2 ベースの DC に直接インストールすることもできます（ただし、懸念事項の分離のため、一般的には専用サーバーが推奨されます）\[10\]。EC2 上の自己管理型 AD を選択すると、AD トポロジと構成を完全に制御できるため、複雑なシナリオには必要になる場合がありますが、顧客は DC の正常性、可用性、およびセキュリティにも責任を負うことになり、これらは Entra Cloud Sync の信頼性に直接影響します。AD ドメインコントローラーの正常性とアクセシビリティは、Cloud Sync エージェントが機能するための最重要事項です。EC2 ベースの DC が適切に管理されていないか、高可用性でない場合、Cloud Sync 自体がどれほど適切に構成されていても同期は失敗します。

**2\. 主要な前提条件と計画に関する考慮事項**

2.1. Microsoft Entra ID ライセンスと管理者ロール  
グループプロビジョニング（書き戻し）機能を使用するには、Microsoft Entra ID P1 ライセンスが必要です 4。Microsoft Entra 管理センターで Cloud Sync を構成するには、ハイブリッドID管理者アカウント（ゲストユーザーではない）が必要です 10。  
ライセンスは機能の可用性にとって基本的なゲートです。ハイブリッドID管理者ロールは、Entra ID 内で同期構成を作成および管理するために必要なアクセス許可を提供します。組織は、グループ書き戻しによって管理または影響を受ける可能性のあるすべてのユーザー（管理者アカウントだけでなく）に対して、Entra ID P1 ライセンスの継続的なコストを考慮に入れる必要があります。ライセンスは多くの場合ユーザーごとです。多数のユーザーが書き戻されるグループのメンバーである場合、P1 ライセンス要件は、予算編成が必要な重大な運用経費となる可能性があります。

2.2. Active Directory 環境 (AWS Managed AD / AD on EC2) の準備  
グループ書き戻しには、AD スキーマ属性 msDS-ExternalDirectoryObjectId が必要です 10。この属性は通常、Windows Server 2016 AD スキーマ以降に存在します。オンプレミス（または AWS ホスト型 AD）環境は、書き戻されたグループのユニバーサルグループスコープをサポートする必要があります 4。  
これらの AD 側の前提条件により、ターゲットディレクトリが、Entra Cloud Sync によってプロビジョニングされたグループオブジェクトとそのメンバーシップを正しく格納および管理できるようになります。msDS-ExternalDirectoryObjectId は、クラウドグループオブジェクトをオンプレミス/AWS AD グループオブジェクトにリンクするために使用されます。Entra Connect Sync グループ書き戻し v2 から移行する場合、Connect Sync v2 が使用していた adminDescription 属性から msDS-ExternalDirectoryObjectId を設定するために特定の手順が必要です 12。これは重要な移行手順です。msDS-ExternalDirectoryObjectId を正しく設定しないと、Cloud Sync は Connect Sync v2 によって以前に書き戻された既存のグループを照合および管理できなくなり、重複グループや同期障害が発生する可能性があります。

2.3. Entra Cloud Sync エージェントサーバーの要件 (OS、リソース、ドメイン参加)  
Windows Server 2016 以降、最低 4 GB の RAM、および.NET Framework 4.7.1 以降のランタイムが必要です 10。エージェントをホストするサーバーは、同期対象の Active Directory フォレストにドメイン参加している必要があります 13。エージェントをドメインコントローラーにインストールすることはサポートされていますが、エージェントサーバーを Tier 0 資産として強化することが推奨されます 10。  
これらは、Cloud Sync エージェントをホストする EC2 インスタンスのベースライン要件です。ドメイン参加は、エージェントが AD と通信し、gMSA 機能を利用するために不可欠です。DC へのインストールはサポートされていますが、セキュリティ衛生と役割の分離を向上させるためには、エージェントを専用のドメイン参加済みメンバーサーバー EC2 インスタンスに展開することが、AWS における望ましいアーキテクチャです。これらのメンバーサーバーは強化する必要があります。ドメインコントローラーは機密性が高いです。追加のソフトウェア、特にクラウドと通信するソフトウェアをインストールすると、攻撃対象領域が増加します。専用のメンバーサーバーは、侵害されたエージェントサーバーの潜在的な影響を制限し、DC のような重要なインフラストラクチャに対する最小機能の原則に沿っています。配置場所に関係なく強化 10 が重要です。

2.4. Cloud Sync エージェント用のグループ管理サービスアカウント (gMSA)  
Cloud Sync エージェントは、グループ管理サービスアカウント (gMSA) を使用してエージェントサービスを実行します 2。エージェントインストールウィザードは、ドメイン管理者資格情報が提供されれば、この gMSA (例: provAgentgMSA$) を作成できます。または、事前に作成されたカスタム gMSA を使用することもできます 15。gMSA の前提条件には、gMSA ドメインフォレストの AD スキーマが Windows Server 2012 以降に更新されていること、DC に PowerShell RSAT モジュールがあること、および少なくとも 1 つの DC が Windows Server 2012 以降を実行していることが含まれます。エージェントサーバー自体 (EC2 インスタンス) は Windows Server 2016 以降である必要があります 13。  
gMSA はパスワードを自動的に管理することで、サービスアカウントのセキュリティを強化します。エージェントをインストールする前に、AD 環境が gMSA の前提条件を満たしていることを確認することが不可欠です。エージェントセットアップ中に gMSA を作成するためにドメイン管理者資格情報が必要であること 15 は、高い権限の使用箇所を浮き彫りにします。便利ではありますが、厳格な変更管理を行う組織では、インストール中の最小権限を遵守するために、必要な権限を持つ gMSA を事前に作成し、エージェントセットアップ中にその名前を提供することを好む場合があります。ドメイン管理者資格情報を一時的にでもソフトウェアのインストールに使用することは、セキュリティ上の懸念事項となる可能性があります。gMSA を事前に作成することで、インストールプロセス自体に広範な管理者権限を付与するのではなく、gMSA が特別に必要とする権限をより制御された形で委任できます。カスタム gMSA の権限については、13 に詳述されています。

**3\. アーキテクチャ設計: AWS 環境における Entra Cloud Sync**

3.1. AWS における推奨ネットワークアーキテクチャ  
3.1.1. VPC およびサブネット設計 (AD および Cloud Sync エージェント用)  
一般的な AWS のベストプラクティスでは、高可用性のために、リージョン内に少なくとも 2 つのドメインコントローラーを、異なるアベイラビリティーゾーン (AZ) に配置することを推奨しています。DC およびその他のインターネットに面していないサーバー (Cloud Sync エージェントなど) は、プライベートサブネットに配置する必要があります 9。これにより、AD インフラストラクチャの回復力が確保されます。ID 同期に不可欠な Cloud Sync エージェントも、高可用性を考慮して展開する必要があり、通常は複数の AZ にまたがり、それぞれプライベートサブネットに配置します。複数の VPC を使用する場合は、VPC ピアリング、AWS Transit Gateway、または VPN を介したネットワーク接続を確保します 9。AD (Managed AD または EC2 DC) が 1 つの VPC (共有サービス VPC など) にあり、エージェントまたはワークロードが他の VPC にあるシナリオでは、堅牢な VPC 間接続が不可欠です。51 は、Transit Gateway またはピアリングを介して接続された共有サービス VPC に Managed AD がある場合に、WorkSpaces VPC に AD Connector (エージェントの AD アクセスの必要性と類似) を展開することに具体的に言及しています。一般的なパターンは、AWS Transit Gateway を使用した「ハブアンドスポーク」モデルであり、中央の VPC が AD などの共有サービスをホストする (または AWS Managed AD への接続を提供する) というものです。アプリケーションワークロード (中央集権化されていない場合は Cloud Sync エージェントも含む可能性がある) を含むスポーク VPC は、Transit Gateway を介して接続します。これにより、ルーティングとネットワーク管理が簡素化されます。9 と 18 は、マルチ VPC 接続について説明しています。Transit Gateway 18 は、特に VPC の数が増えるにつれて、広範な VPC ピアリングと比較してルーティングの複雑さを簡素化する方法として強調されています。このパターンは、スケーラビリティと管理可能なネットワークセグメンテーションを促進します。

\*\*3.1.2. セキュリティグループとネットワーク ACL (NACL) の設定\*\*  
Cloud Sync エージェントは、TCP ポート 80 (CRL 検証) および 443 (すべての主要なサービス通信) を介して Microsoft Entra ID へのアウトバウンドアクセスが必要です。ポート 443 が利用できない場合、ステータスレポート用にポート 8080 はオプションです \[13\]。エージェントは、ドメインコントローラーへの TCP/389 (LDAP) および TCP/3268 (グローバルカタログ) を介したインバウンド/アウトバウンドアクセスが必要です \[12, 13\]。

Cloud Sync エージェントをホストする EC2 インスタンスには、この特定のトラフィックを許可するようにセキュリティグループ (ステートフル) を設定する必要があります。Entra ID 通信にはアウトバウンドルール、AD DC 通信にはインバウンドとアウトバウンドの両方のルールが必要です。NACL (ステートレス) は、サブネットレベルで追加の防御層を提供し、両方向で同じトラフィックを許可する必要があります。

\*\*表 3.1.2.1: Entra Cloud Sync エージェントに必要なネットワークポートとプロトコル\*\*  
ネットワーク接続は一般的な障害点です。明確な表は、ネットワークおよびセキュリティチームが正しいルールを実装するのに役立ち、トラブルシューティング時間を短縮し、信頼性の高いエージェントの運用を保証します。

| 送信元 | 送信先 | プロトコル | ポート | 方向 | 目的 |
| :---- | :---- | :---- | :---- | :---- | :---- |
| エージェント EC2 SG | インターネット (Entra ID URL) | TCP | 443 | アウトバウンド | プライマリ Entra Cloud Sync 通信 |
| エージェント EC2 SG | インターネット (CRL/OCSP URL) | TCP | 80 | アウトバウンド | 証明書検証 |
| エージェント EC2 SG | AD DC SG/IP | TCP | 389 | アウトバウンド | LDAP 通信 |
| エージェント EC2 SG | AD DC SG/IP | TCP | 3268 | アウトバウンド | グローバルカタログ通信 |
| AD DC SG/IP | エージェント EC2 SG (LDAP応答など) | TCP | エフェメラル | インバウンド | LDAP 応答 (ステートフルSGの場合不要な場合あり) |
| AD DC SG/IP | エージェント EC2 SG (GC応答など) | TCP | エフェメラル | インバウンド | GC 応答 (ステートフルSGの場合不要な場合あり) |

\*注: 上記は主要なポートです。NACL ルールはインバウンドとアウトバウンドの両方でこれらのポートを許可する必要があります。エフェメラルポートの範囲も考慮してください。\*

セキュリティグループは、最小権限の原則に従う必要があります。Entra ID へのアウトバウンド接続の場合、可能であれば、宛先 IP を Microsoft が公開している Azure データセンターの IP 範囲または FQDN に制限します \[13\]。AD DC 通信の場合は、DC の特定の IP またはセキュリティグループに制限します。\[13\] は、ファイアウォール/プロキシにセキュアサフィックスを使用するか、それが不可能な場合は Azure データセンターの IP 範囲を使用することを明示的に言及しています。これをセキュリティグループに適用すると、攻撃対象領域を最小限に抑え、エージェントが意図しないエンドポイントと通信するのを防ぐことでセキュリティが強化されます。

\*\*3.1.3. エージェントのアウトバウンドインターネットアクセス (NAT ゲートウェイ、プロキシに関する考慮事項)\*\*  
プライベートサブネット内のエージェントは、アウトバウンドインターネット接続 (Entra ID などへの接続) のためのメカニズムを必要とします \[13, 19\]。パブリックサブネットに展開された NAT ゲートウェイは、プライベートサブネット内のインスタンスがアウトバウンドインターネットトラフィックを開始できるようにする一方で、インターネットからのインバウンド接続を防ぐための標準的な AWS ソリューションです。Cloud Sync エージェントはアウトバウンドプロキシ設定をサポートしています \[20\]。企業のポリシーですべてのインターネットバウンドトラフィックがプロキシを経由する必要がある場合、Cloud Sync エージェントをそれに応じて設定できます。このプロキシは、Microsoft Entra サービス URL を許可リストに登録する必要があります。プロキシのサポートは存在しますが、AWS で NAT ゲートウェイを使用する方が、プライベートサブネット内の EC2 インスタンスのアウトバウンド接続を管理する上で、既存の必須プロキシインフラストラクチャを使用する必要がない限り、多くの場合より簡単です。NAT ゲートウェイは AWS マネージドサービスであり、自己管理型プロキシサーバーと比較して運用オーバーヘッドを削減します。VPC ルーティングとシームレスに統合されます。プロキシ設定は、慎重に管理しないと、設定ミスや障害の潜在的なレイヤーを追加します。

\*\*3.1.4. オンプレミス AD への接続性 (Direct Connect/VPN、該当する場合)\*\*  
AWS ホスト型 AD (EC2 上の AD など) がオンプレミス AD を含む大規模なハイブリッド環境の一部である場合、通常、AWS Direct Connect や Site-to-Site VPN などの接続オプションが使用されます \[18, 19\]。これは、AWS 上の Cloud Sync エージェントがオンプレミスの DC と通信する必要がある場合 (たとえば、1 つのフォレストがオンプレミスで別のフォレストが AWS にあり、AWS 上のエージェントが AWS フォレストを同期するが、オンプレミスフォレストから ID を解決する必要があるマルチフォレストシナリオなど) に関連します。ただし、主要なシナリオは Entra ID から AWS AD への同期です。このセクションは、AWS AD が分離されていない場合の包括的なアーキテクチャコンテキストのためです。オンプレミス AD を統合すると、AD サイトとサービス、レプリケーション、DNS 解決が複雑になり、AWS AD 環境がオンプレミスのリソースに依存している場合、これらすべてが Cloud Sync エージェントの運用に間接的に影響を与える可能性があります。Cloud Sync エージェントの主要な対話相手は、構成されているドメインの DC です。そのドメインがオンプレミス AD との信頼関係や依存関係を持っている場合、ハイブリッド AD 接続 (VPN/Direct Connect、AD サイトとサービス) の不安定性や設定ミスは、エージェントの問題 (オブジェクトの解決不能、GC ルックアップの失敗など) として現れる可能性があります。

3.2. EC2 上の Entra Cloud Sync エージェントの展開と配置  
3.2.1. EC2 インスタンスのサイジングと選択  
最低 4GB RAM、Windows Server 2016 以降が必要です 10。Cloud Sync は、AD ドメインあたり最大 150,000 オブジェクト、および最大 50,000 メンバーのグループをサポートします 1。スコープフィルター設定には 4MB の文字数制限があり、これは特定の構成に対して約 50 の個別の OU またはセキュリティグループに相当します 10。

最小 RAM は出発点です。実際のサイジングでは、同期されるオブジェクトの数と構成の複雑さ (スコープ内の OU/グループの数) を考慮する必要があります。

\*\*表 3.2.1.1: Cloud Sync エージェントの EC2 インスタンスサイジング推奨\*\*  
適切な EC2 インスタンスタイプを選択することは、コストとパフォーマンスのバランスを取る上で重要です。サイジングが不十分なインスタンスはパフォーマンスの問題や同期の失敗につながる可能性があり、サイジングが過大なインスタンスは不必要なコストを発生させます。

| シナリオ (オブジェクト/グループ数) | 推奨 EC2 インスタンスタイプ | vCPU | メモリ (GiB) | 備考 |
| :---- | :---- | :---- | :---- | :---- |
| 小規模 (例: \< 50,000 オブジェクト, \< 1000 グループ) | t3.medium | 2 | 4 | 最小 RAM を満たし、小規模な負荷に適しています。 |
| 中規模 (例: 50,000-100,000 オブジェクト, \< 5000 グループ) | m5.large | 2 | 8 | より大きなオブジェクトセットに対応するためにより多くのメモリを搭載。 |
| 大規模 (例: \>100,000 オブジェクト, 最大 150,000, 大規模グループ多数) | m5.xlarge | 4 | 16 | より高い負荷と処理能力に対応するためにより多くの CPU とメモリを搭載。 |

AWS は様々な EC2 インスタンスファミリー (汎用 \- T シリーズ、M シリーズなど) を提供しています \[21, 22\]。汎用の M シリーズまたは T シリーズ (バースト可能な CPU が許容される場合) が有力な候補です。Microsoft は最小要件を提供していますが、エージェント EC2 インスタンスの実際の CPU/メモリ使用量を (CloudWatch を使用して \[23, 24\]) 監視することは、適切なサイジングのために不可欠です。妥当なサイズ (t3.medium や m5.large など) から開始し、パフォーマンスデータに基づいて調整してコストとパフォーマンスのバランスを取ります。Cloud Sync の 150,000 オブジェクト制限 \[10\] は Microsoft によるハードリミットです。EC2 インスタンスは、スコープ内のオブジェクトの処理を効率的に処理できる十分な能力を備えている必要があります。AWS Compute Optimizer や単純な CloudWatch メトリクスは、インスタンスが過剰または過小に利用されているかどうかを特定するのに役立ちます \[25, 26\]。

\*\*3.2.2. エージェントのインストールと gMSA の設定\*\*  
エージェントのインストールには \`AADConnectProvisioningAgentSetup.exe\` を実行します \[15\]。ウィザードは、Entra ID 認証、AD ドメイン接続、および gMSA セットアップをガイドします \[14, 15\]。これは標準的な Microsoft のインストールプロセスであり、EC2 インスタンス上で実行されるように適合されています。

\*\*3.2.3. EC2 インスタンスプロファイル用の IAM ロールとポリシー (最小権限)\*\*  
EC2 インスタンスは IAM ロール (インスタンスプロファイル) を使用して、インスタンスに認証情報を埋め込むことなく他の AWS サービスに安全にアクセスできます \[27, 28\]。EC2 インスタンスが AWS Managed Microsoft AD ドメインに\*シームレスに参加\*するためには、インスタンスプロファイルに \`AmazonSSMManagedInstanceCore\` および \`AmazonSSMDirectoryServiceAccess\` ポリシーが必要です \[28, 29\]。参加を開始するユーザー/ロールには、\`ds:CreateComputer\` のような権限も必要です。

Cloud Sync エージェント自体は主に LDAP を介して AD と、HTTPS を介して Entra ID と対話しますが、EC2 ホストは AWS サービス (管理用の Systems Manager、ロギング/監視用の CloudWatch など) の IAM 権限が必要になる場合があります。エージェントが (LDAP を使用するため、グループ書き戻しでは可能性は低いですが) AWS API を介して AWS Managed AD リソースに対してアクションを実行する場合、特定の \`ds:\*\` 権限が必要になります。グループ書き戻しの主要な AD 対話は OS/LDAP レベルであり、gMSA の AD 権限によって管理されます。Cloud Sync エージェントが AD にグループを\*書き込む\*ための重要な権限は、AWS IAM 権限ではなく、gMSA に付与された AD 権限です。EC2 インスタンスの IAM ロールは、主に AWS サービスとの対話 (CloudWatch エージェント、SSM エージェントなど) のためのものです。ただし、EC2 上のスクリプトが AD 管理のために (Cloud Sync の直接的な操作以外で) AWS Directory Service API を使用する場合、IAM 権限 (ds:CreateGroup、ds:AddMemberToGroups など) はそのスクリプトの ID に関連します \[30, 31\]。Entra Cloud Sync の AD へのグループプロビジョニングは、gMSA によって認証された LDAP 操作を使用します。\`ds:CreateGroup\` のような AWS Directory Service API を直接呼び出すことはありません。EC2 インスタンスの IAM ロールは、インスタンスの AWS サービスとの対話のためのものです。\[32\] は、Entra Connect がユーザーを Microsoft AD に同期することを示しており、これは AD レベルの操作であることを意味します。\[28, 31\] のようなスニペットは、Cloud Sync エージェントの LDAP 操作ではなく、EC2 インスタンスの\*ドメイン参加\*または AWS API を介したディレクトリの\*管理\*のための IAM 権限に言及しています。

\*\*表 3.2.3.1: Cloud Sync エージェント EC2 インスタンスプロファイルの推奨 IAM ポリシー\*\*  
EC2 インスタンスが AWS エコシステム内で効果的に管理および監視されるように、運用面に焦点を当てて Cloud Sync エージェントをホストする EC2 インスタンスに必要な AWS IAM 権限を定義します。

| ポリシー名 | 目的 | 主要な IAM アクション (例) |
| :---- | :---- | :---- |
| AmazonSSMManagedInstanceCore | AWS Systems Manager を介したインスタンス管理を許可します。 | ssm:UpdateInstanceInformation, ssmmessages:\*, ec2messages:\* |
| CloudWatchAgentServerPolicy | CloudWatch へのメトリクスとログの発行を許可します。 | cloudwatch:PutMetricData, logs:CreateLogGroup, logs:CreateLogStream, logs:PutLogEvents |
| (オプション) AmazonSSMDirectoryServiceAccess | SSM を介して起動後にシームレスなドメイン参加が管理される場合。 | ds:CreateComputer (SSM ドキュメント経由での参加の場合) |

\*\*3.2.4. Cloud Sync エージェントの高可用性 (マルチ AZ 配置)\*\*  
Microsoft は高可用性のために 3 つのアクティブなエージェントをインストールすることを推奨しています \[10\]。これらのエージェントを AWS リージョン内の異なるアベイラビリティーゾーン (AZ) にまたがる EC2 インスタンスに展開することは、HA に関する AWS のベストプラクティスに沿っています。Microsoft の複数エージェントの推奨と AWS のマルチ AZ 配置戦略を組み合わせることで、同期サービスの堅牢なフォールトトレランスが提供されます。1 つの AZ で障害が発生した場合、他の AZ のエージェントは引き続き動作できるため、同期が継続されます。これには、AD ドメインコントローラー (AWS Managed AD または EC2 ベースの DC) もマルチ AZ 方式で展開されている必要があります。

表: AD on EC2 と AWS Managed Microsoft AD の比較 (Entra Cloud Sync 向け)  
AWS 上の AD ホスティングモデルの選択は、管理、コスト、制御に大きな影響を与え、これらすべてが Cloud Sync の展開と相互作用します。

| 特徴/考慮事項 | AD on EC2 | AWS Managed Microsoft AD |
| :---- | :---- | :---- |
| 管理オーバーヘッド | 高 (OS、AD、パッチング、バックアップすべて顧客責任) | 低 (AWS が DC を管理) |
| AD に対する制御 | 完全 | 制限あり (スキーマ拡張は可能だが、ドメイン/エンタープライズ管理者権限は限定的) |
| スキーマ拡張 | 可能 | 可能 (LDIF ファイル経由 33) |
| コスト構造 | EC2 インスタンス、ストレージ、データ転送 | DC ごとの時間料金、データ転送、共有コスト 34 |
| Entra Cloud Sync エージェント配置 | 専用メンバーサーバー EC2 (推奨) または DC EC2 | 専用メンバーサーバー EC2 (ドメイン参加) |
| IAM 統合の複雑さ | EC2 インスタンスプロファイルのみ | EC2 インスタンスプロファイル、Managed AD サービス固有の考慮事項が追加される可能性あり |
| スケーラビリティ | 手動で DC を追加/削除 | AWS コンソール/API を介して DC を追加可能 7 |

**4\. 設定: Entra ID グループの AWS Active Directory へのプロビジョニング**

4.1. Entra 管理センターでの「Microsoft Entra ID から AD への同期」設定  
Microsoft Entra 管理センターで、Entra ID \> Entra Connect \> Cloud sync に移動します。「新しい構成」を選択し、次に「Microsoft Entra ID から AD への同期」を選択します。ドメインを選択し、必要に応じてパスワードハッシュ同期を有効にします 35。これはグループ書き戻し機能の設定の開始点です。選択するドメインは、エージェントが登録されている AWS ホスト型 AD ドメインである必要があります。  
4.2. 同期スコープの定義 (グループ/OU のスコープフィルター)  
スコープフィルターは、どのオブジェクトを同期するかを定義します。AD へのグループプロビジョニングでは、「すべてのセキュリティグループ」または「選択したセキュリティグループ」にスコープを設定できます 3。これにより、どの Entra ID グループを AWS AD に書き戻すかをきめ細かく制御できます。段階的な展開や、必要なグループのみに同期を制限する場合に不可欠です。初期設定とテストでは、スコープを非常に限定的 (特定のテストセキュリティグループなど) に開始し、その後「すべてのセキュリティグループ」またはより大きな選択グループセットに拡大することが推奨されます。これにより、初期設定中のリスクが最小限に抑えられます。36 によると、大規模グループの同期には制限があるため、パイロットシナリオではグループスコープフィルタリングを使用することが推奨されます。小規模で制御されたセットでテストすることで、広範囲に適用する前に構成が正しいことを確認できます。  
4.3. AD における属性マッピングとターゲットコンテナの指定  
属性マッピングはカスタマイズ可能です。グループプロビジョニングでは、parentDistinguishedName 属性をマッピング (定数、直接、または Switch() のような式マッピングを使用) して、グループが作成される AD 内のターゲット OU を指定できます 3。式 の例: Switch(\[displayName\],"OU=Groups,DC=contoso,DC=com","Marketing","OU=Marketing,DC=contoso,DC=com","Sales","OU=Sales,DC=contoso,DC=com") 12。  
これにより、書き戻されたグループを単一のデフォルトコンテナではなく、AWS AD 内の特定の OU に整理できます。これは、AD 内で GPO を適用したり、管理委任を行ったりする場合に重要です。書き戻されたグループの AD OU 構造を慎重に計画してください。グループ属性 (displayName やカスタム拡張属性など) に基づいて parentDistinguishedName に式を使用すると柔軟性が得られますが、慎重な設計とテストが必要です。AD における明確に定義された OU 構造は管理に不可欠です。Switch() 関数 12 はグループ配置のための強力な条件付きロジックを提供しますが、複雑な式はトラブルシューティングが困難になる可能性があります。初期展開では、より単純なマッピングまたはデフォルト OU の方が適している場合があります。

4.4. パスワードハッシュ同期 (PHS) の有効化とその影響  
「Microsoft Entra ID から AD への同期」設定中にパスワードハッシュ同期を有効にできます 35。主な要求は Entra ID から AD への グループプロビジョニングですが、PHS は通常、AD から Entra ID への ユーザー同期のために設定されます。「Entra ID から AD への同期」コンテキストで PHS を有効にすることは UI 3 にオプションとして表示されますが、書き戻されるグループオブジェクトに対する直接的な影響はあまり明確ではありません。これは、ユーザーオブジェクトも Entra ID から AD にプロビジョニングされる場合 (これは一般ユーザー向けの標準的な Cloud Sync 機能ではありません 37\) により関連性があります。グループプロビジョニング自体にとって、グループオブジェクトの PHS は概念ではありません。メンバーユーザーの PHS (最初に AD から Entra ID に同期される) が Entra ID に対する認証を可能にするものです。クエリは、全体的なハイブリッド設定で PHS が有効になっていることを示唆しています。「Entra ID から AD への同期」設定 3 内の PHS オプションは、ユーザーが AD にプロビジョニングされ、Entra ID パスワードを AD で使用する必要がある場合 (たとえば、SSPR シナリオで Entra ID で変更されたパスワードが AD に書き戻される場合など) のユーザーのパスワード書き戻しに関連する可能性が高いです。グループプロビジョニングの場合、PHS 自体はグループオブジェクトの概念ではありません。UI オプションは、設定ブレードの一般的な設定である可能性があります。このシナリオで重要な PHS は、ユーザーのパスワードハッシュを AWS AD から Entra ID に 同期するものであり、ユーザーが Entra ID に認証できるようにするものです。その後、Entra ID でパスワードが変更された場合、パスワードの書き戻し (AD への PHS の一種) がそれらのユーザーに関連します。  
4.5. オンデマンドプロビジョニングによる同期のテスト  
オンデマンドプロビジョニングを使用すると、完全な展開の前に、単一のグループ (グループプロビジョニングの場合は一度に最大 5 メンバー) で構成の変更をテストできます 3。これは、すべてのスコープ指定されたグループに対して構成を有効にする前に、特定のグループの属性マッピング、OU 配置、および一般的な同期の正常性を検証するための重要なステップです。  
4.6. サポートされるグループの種類、制限事項、およびスケーラビリティ  
AD へのプロビジョニングでは、クラウドで作成されたセキュリティグループのみがサポートされます。これらは割り当て済みまたは動的メンバーシップを持つことができます。メンバーは、オンプレミスで同期されたユーザー (つまり、元々 AD からのもので、Entra ID に同期され、現在は書き戻されるクラウドグループのメンバーであるユーザー) および/または他のクラウドで作成されたセキュリティグループである必要があります 4。クラウド専用ユーザーは、これらのグループにプロビジョニングして AD に戻すことはできません 40。グループはユニバーサルスコープで書き戻されます 4。  
制限事項: グループあたり最大 50,000 メンバー。この機能ではテナント内の合計オブジェクト (ユーザー \+ グループ) が最大 150,000。ネストされたグループのメンバーはプロビジョニングされません (スコープ内であればネストされたグループオブジェクト自体のみ)。AD でグループが手動で更新された場合、調整はサポートされません 4。Microsoft 365 グループは、Cloud Sync の「AD へのグループプロビジョニング」機能による書き戻しは直接サポートされていません。M365 グループの書き戻しには、依然として Entra Connect Sync v1 が言及されています 4。

これらの制限は計画にとって重要です。グループの種類、そのメンバーシップ、および全体的な規模によって、Cloud Sync が適合するかどうかが決まります。セキュリティグループと Microsoft 365 グループの区別は非常に重要です。

表 4.6.1: Entra Cloud Sync の AD へのグループプロビジョニングの主な制限事項  
制限を事前に理解することで、予期しない問題を回避し、現実的な期待値を設定するのに役立ちます。この表は、複数の情報源からの重要な制約を統合したものです。

| 制限カテゴリ | 具体的な制限 | 影響/回避策 |
| :---- | :---- | :---- |
| グループの種類 | クラウドで作成されたセキュリティグループのみ | M365 グループには Connect Sync v1 が必要です。 |
| グループメンバーシップ | メンバーは AD 同期ユーザーまたは他のクラウドセキュリティグループである必要があります (クラウド専用ユーザーは書き戻されません)。 | クラウド専用ユーザーは AD に書き戻されません。 |
| ネスト | ネストされたグループの*メンバー*はプロビジョニングされません。 | すべてのメンバーグループをスコープに追加します。 |
| スケール | グループあたり最大 50k メンバー、テナントあたり合計 150k オブジェクト。 | 大規模な展開では注意が必要です。 |
| 手動 AD 編集 | 調整はサポートされていません。 | グループは Entra ID で管理します。 |
| Microsoft 365 グループ | Cloud Sync のこの機能では直接サポートされていません。 | M365 グループの書き戻しには Entra Connect Sync v1 を使用します 4。 |

Microsoft は多くのシナリオで AD 同期のための戦略的なパスとして Entra Cloud Sync を位置づけていますが、Entra Connect Sync と比較していくつかの機能ギャップが依然として存在します (例: M365 グループ書き戻し、デバイス書き戻し 1)。これは、一部の組織が両方のツールを並行して実行する必要があるか、Cloud Sync がすべてのハイブリッド要件を満たしているかどうかを慎重に評価する必要があることを意味します。1 のようなスニペットは、Cloud Sync を「新しいオファリング」および特定の機能の後継として示していますが、特に M365 グループに関する制限 4 は、それがまだすべての Entra Connect Sync ユースケースの完全な代替ではないことを示しています。ユーザーのクエリは特に AWS AD へのグループ同期に関するものであり、これに対して Cloud Sync は*セキュリティグループ*のための意図されたツールです。

**5\. 同期後: AWS AD リソースへの認証**

5.1. 認証フローの概要 (AD から Entra ID への同期で PHS が有効な場合)  
ID が AWS AD から発信され、PHS を使用して Entra ID に同期されたユーザーが、AWS AD ドメインに参加しているリソース (ファイルサーバー、アプリ) にアクセスする場合、認証は AWS AD ドメインコントローラーに対して行われます。  
Entra Cloud Sync の AD へのグループプロビジョニングにより、クラウド管理グループが AD でリソースの ACL 設定に利用可能になります。これらの AD 参加リソースへの実際の認証は、標準の AD プロトコル (Kerberos、NTLM) を使用します。Entra ID への PHS により、ユーザーは AD パスワードを使用して Entra ID に認証できますが、AD リソースの場合、AWS AD が認証局となります。AD 認証に関連するスニペット 42 は、AD コンテキストでの Kerberos/NTLM について説明しています。44 は、Entra ID 認証のための PHS の仕組みを詳述していますが、オンプレミスリソースのユーザー認証は依然としてオンプレミス AD に対して行われることを明確にしています。

5.2. AWS AD ドメインコントローラーの役割 (KDC)  
Active Directory 環境では、ドメインコントローラーが Kerberos 認証のためのキー配布センター (KDC) として機能します 43。ユーザーが AWS AD ドメイン内の Kerberos 対応リソースにアクセスすると、AWS AD DC が Kerberos チケット (TGT およびサービスチケット) を発行します。  
5.3. Kerberos および NTLM 認証メカニズム  
Kerberos は AD の主要な認証プロトコルです。NTLM はフォールバックとして使用されるレガシープロトコルです 43。

* **Kerberos フロー (AD リソースアクセス用に簡略化):**  
  1. ユーザーがドメイン参加マシンにログインするか、ドメインリソースへのアクセスを開始します。  
  2. クライアントは、ユーザーの資格情報 (パスワードハッシュから派生) を使用して KDC (AWS AD DC) からチケット許可チケット (TGT) を要求します。  
  3. KDC は資格情報を検証し、暗号化された TGT を返します。  
  4. クライアントは、TGT を提示して、特定のリソース (ファイルサーバーなど) のサービスチケットを KDC に要求します。  
  5. KDC は TGT を検証し、リソースの暗号化されたサービスチケットを発行します。  
  6. クライアントはサービスチケットをリソースサーバーに提示します。  
  7. リソースサーバーはサービスチケットを検証し (多くの場合 KDC と連携)、アクセスを許可します。  
* **NTLM フロー (簡略化):** チャレンジ/レスポンスプロトコル。通常、Kerberos が失敗した場合や、アプリケーション/クライアントでサポートされていない場合に使用されます。

Entra ID PHS (AD から Entra へ) は、Entra ID *への* 認証を可能にします。AWS AD リソースにアクセスする場合、認証は *AWS AD DC に対して* 行われます。Entra ID に同期されたパスワードハッシュは、Entra ID ログインに使用されます。オンプレミス/AWS AD ログインの場合、元の AD パスワードハッシュメカニズムが使用されます。Entra ID から AD へのパスワード書き戻し (SSPR 経由など) も有効になっている場合、Entra ID で変更されたパスワードは AD パスワードを更新し、その後、新しいパスワードで AD 認証が可能になります。44 は、PHS が Entra ID サインインに使用される場合、「ユーザー認証は組織独自の Active Directory インスタンスに対してではなく、Microsoft Entra に対して行われる」と明確に述べています。AD ドメイン (AWS ホスト型) 内のリソースの場合、AD 自体が認証局です。Cloud Sync によって書き戻されたグループは、これらの AD リソースの承認 (ACL) のためのものです。

5.4. AWS AD リソースのユーザー認証における Entra ID と AWS AD の相互作用  
AWS AD ドメイン内のリソースに直接アクセスする場合、Entra ID の主な役割 (このグループ書き戻しと PHS の特定のコンテキストにおいて) は、ユーザーとグループの ID 情報の一貫性を確保することです。認証イベント自体は AWS AD によって処理されます。Entra ID は AWS AD リソースの中間 KDC ではありません。  
「クラウド Kerberos 信頼」が構成されている場合 42、フローは異なる可能性がありますが、PHS を使用した標準的な AD リソースアクセスは AD 自体に依存します。「Microsoft Entra ID から AD への同期」設定 3 で言及されている「パスワードハッシュ同期」は、ユーザーが AD *に* プロビジョニングされ、Entra ID パスワードを AD で使用する必要がある場合に、パスワード書き戻しのためである可能性が高いです。ユーザーの主要なシナリオ (グループが AD にプロビジョニングされ、ユーザーは AD に存在し、PHS を使用して Entra ID に同期される) では、AWS AD リソースへの認証は標準的な AD 認証です。クエリは、グループ書き戻し後および PHS が有効な場合の AWS AD リソースへの認証について尋ねています。AD から Entra ID への PHS により、ユーザーは Entra ID にサインインできます。グループ書き戻しにより、Entra ID グループが AD に配置されます。AWS AD 参加マシン上のファイルサーバーへのアクセスは、AWS AD DC に対する Kerberos/NTLM をトリガーします。Entra ID は、ID ライフサイクルと AD で使用されるグループ定義を管理しますが、ファイルサーバーへの特定の認証パスに直接関与しません。

**6\. 運用上の考慮事項**

6.1. エージェントの正常性と同期状態の監視  
エージェントの正常性とプロビジョニングログは、Microsoft Entra 管理センター (Cloud Sync セクション) で確認できます 15。エージェントをホストする EC2 インスタンスについては、AWS CloudWatch を使用して OS レベルのメトリクス (CPU、メモリ、ディスク、ネットワーク) とログを監視できます。CloudWatch エージェントを EC2 インスタンスにインストールして設定する必要があります 23。Azure Monitor は、Azure Arc 対応サーバーを使用して AWS 環境と統合し、クラウド間で一貫した監視エクスペリエンスを提供できます。AWS サービスログデータは Microsoft Sentinel (Azure Monitor/Log Analytics の一部) に取り込むことができます 45。  
包括的な監視戦略には、Cloud Sync サービスの正常性のための Azure ネイティブツールと、エージェントを実行している EC2 インフラストラクチャの正常性のための AWS ネイティブツールの両方を使用することが含まれます。Cloud Sync エージェント EC2 インスタンスに Azure Arc for servers を実装します。これにより、AWS CloudWatch と並行して Azure からの集中監視とガバナンス (Azure Monitor、Azure Policy) が可能になり、ハイブリッドサーバー管理のための単一の管理画面が提供されます。45 は、一貫したエクスペリエンスと Azure Monitor エージェントの使用のために、Azure Arc 対応サーバーについて明示的に言及しています。これにより、ハイブリッドワークロードの監視が簡素化されます。エージェントサーバーの主要な EC2 メトリクス (CPU、メモリ、ディスク容量) に対して CloudWatch アラームを設定します 23。また、プロビジョニングエラーまたは検疫のために Entra Cloud Sync で電子メール通知を設定します 35。プロアクティブなアラートにより、管理者はエージェントインフラストラクチャまたは同期プロセスの問題がエスカレートしてユーザーまたはリソースへのアクセスに影響を与える前に通知されます。

6.2. 一般的な問題のトラブルシューティング (接続性、権限、同期エラー)  
一般的なエージェントの問題には、インストールエラー、エージェントが実行されていない、エージェントがポータルに表示されない/正常でないなどがあります 20。PowerShell 実行ポリシーがインストールエラーを引き起こす可能性があります 20。Azure ポータルのプロビジョニングログは、オブジェクト同期の問題を特定するための鍵となります 20。異常な構成は検疫状態になります 20。AWS Managed Microsoft AD の場合、トラブルシューティングには CloudWatch Logs で AD イベント ID (Netlogon 問題の場合は 5827、5828 など) を確認することが含まれる場合があります 46。重複するユーザーログオン名が「400 Bad Request」エラーを引き起こす可能性があります 46。  
トラブルシューティングには、エージェントのステータス、ネットワーク接続、権限 (gMSA の AD 権限と関連する場合は EC2 の IAM 権限) を確認し、その後サービス固有のログを調査するという系統的なアプローチが含まれます。

表 6.2.1: AWS における Entra Cloud Sync の一般的な問題のトラブルシューティング  
構造化されたトラブルシューティング表は、管理者が潜在的な原因と解決策を迅速に特定し、ダウンタイムを削減するのに役立ちます。

| 症状/エラーコード | 考えられる原因 (Microsoft/AWS) | トラブルシューティング手順 | 関連スニペット |
| :---- | :---- | :---- | :---- |
| EC2 へのエージェントインストール失敗 | PowerShell 実行ポリシー、.NET バージョン、OS バージョン | PowerShell 実行ポリシーを RemoteSigned または Undefined に設定、前提条件を確認 | 10 |
| エージェントはインストールされたが Azure ポータルで正常でない | ネットワーク接続 (SG/NACL、プロキシ、NAT)、DNS 解決、gMSA 権限 | ポート 80/443 のアウトバウンド接続確認、Entra ID エンドポイントへの名前解決確認、gMSA が AD で必要な権限を持っているか確認 | 13 |
| グループが AD にプロビジョニングされない | スコープフィルター、属性マッピングエラー、gMSA の AD 権限、msDS-ExternalDirectoryObjectId の欠落/不正確、AD ユニバーサルスコープ | Entra Cloud Sync 構成のスコープとマッピングを確認、gMSA がグループ作成/変更権限を持つことを確認、ターゲット AD で msDS-ExternalDirectoryObjectId を確認/設定 | 3 |
| プロビジョニングログの同期エラー | 特定のエラーコードを参照、AD/Entra ID ルールに対するオブジェクト属性を確認 | Azure ポータルのプロビジョニングログで詳細なエラーメッセージを確認し、Microsoft のドキュメントでエラーコードを検索 | 20 |
| AWS Managed AD エラー (例: Netlogon) | AWS Managed AD 側の問題、Netlogon セキュアチャネル通信の問題 | AWS CloudWatch ログで AD イベント ID (5827, 5828 など) を確認、AWS サポートに問い合わせる | 46 |
| エージェントサービス (Microsoft Entra Provisioning Agent) が開始しない | gMSA アカウントの権限不足、グループポリシーによるサービス開始権限の制限 | サービスログオンアカウントを一時的にドメイン管理者に変更してテスト、関連するグループポリシーを確認 20 | 20 |

6.3. ハイブリッド環境のセキュリティベストプラクティス  
Microsoft Entra プロビジョニングエージェントサーバーを強化します (可能であれば Tier 0 資産として) 10。管理者アクセスを制限し、専用アカウントを使用します。  
標準的なセキュリティベストプラクティスを適用します:

* ネットワークセグメンテーション (エージェントと DC 用のプライベートサブネット)。  
* gMSA の AD および EC2 インスタンスの IAM ロールに対する最小権限の原則。  
* エージェントサーバーの定期的なパッチ適用と更新 (OS およびエージェントソフトウェア \- エージェントは自動更新 17)。  
* Entra ID、AWS (CloudTrail、CloudWatch Logs)、および AD の監査ログの監視。

セキュリティは共同責任です。Microsoft は Entra ID サービスを保護し、AWS は Managed AD および EC2 の基盤となるインフラストラクチャを保護しますが、Cloud Sync エージェント構成、それらをホストする EC2 インスタンス、VPC 内のネットワーク構成、および付与された AD 権限の保護は顧客の責任です。多層防御アプローチが必要です。いずれかのレイヤー (Entra ID、エージェントサーバー、AWS ネットワーク、AD 権限) での設定ミスは、セキュリティの脆弱性や同期の失敗につながる可能性があります。

**7\. コストへの影響**

7.1. Microsoft Entra ID ライセンスコスト  
AD へのグループプロビジョニングには Microsoft Entra ID P1 が必要であり、ユーザーごと/月額で価格設定されます (例: $6.00/ユーザー/月) 4。P2 には P1 の機能に加えて高度な ID 保護が含まれます (例: $9.00/ユーザー/月) 11。これは、P1/P2 機能の恩恵を受ける、またはそれによって管理されるユーザー数に基づく継続的な運用コストです。  
7.2. AWS サービスコスト  
EC2 のコストは、インスタンスタイプ、サイズ、リージョン、および料金モデル (オンデマンド、リザーブドインスタンス、Savings Plans) によって異なります 47。AWS へのデータ転送 IN は通常無料です。AWS からインターネットへのデータ転送 OUT は GB ごとに課金されます (最初の 100GB/月はサービス全体で無料) 47。同じリージョン内の AZ 間のデータ転送にもコストが発生します 48。AWS Managed Microsoft AD は、ドメインコントローラーごとに時間単位で価格設定され、エディション (Standard/Enterprise) とリージョンによって異なります。追加の DC、ディレクトリ共有、およびマルチリージョンレプリケーションデータ転送には追加コストがかかります 34。NAT ゲートウェイ (時間ごとおよび処理 GB ごと)、VPN/Direct Connect にも関連コストがあります。  
完全なコストモデルでは、これらすべての AWS コンポーネントを考慮に入れる必要があります。Cloud Sync エージェントの Entra ID との通信 (AWS からのアウトバウンド) および AD DC との通信 (潜在的な AZ 間) のデータ転送コストを見積もる必要があります。

表 7.2.1: コスト構成要素の内訳と見積もりガイダンス  
総所有コストの見積もりを構造化された方法で提供することで、予算編成と財務計画に役立ちます。

| コンポーネント | プロバイダー | コストドライバー | 価格例/備考 | 関連スニペット |
| :---- | :---- | :---- | :---- | :---- |
| Entra ID P1/P2 ライセンス | Microsoft | ユーザー数 | P1: $6.00/ユーザー/月 (年契約) 11 | 11 |
| EC2 インスタンス (エージェント) | AWS | インスタンス時間、タイプ、リージョン | オンデマンド、リザーブドインスタンス、Savings Plans。例: t3.medium (Linux、バージニア北部): 約 $0.0208/時 47 | 47 |
| AWS Managed Microsoft AD | AWS | DC 時間、エディション、リージョン | Standard Edition (バージニア北部): $0.12/時 (2 DC) 34 | 34 |
| データ転送 (エージェントから Entra ID) | AWS | インターネットへのアウトバウンド GB | 最初の 100GB/月は無料、その後段階的料金 48 | 47 |
| データ転送 (AZ 間 HA) | AWS | AZ 間 GB | リージョン内データ転送: $0.01/GB (送受信それぞれ) 48 | 48 |
| NAT ゲートウェイ | AWS | 時間ごと \+ 処理 GB ごと | バージニア北部: $0.045/時 \+ $0.045/GB | AWS 料金ページ参照 |
| CloudWatch ログ/メトリクス | AWS | 取り込み/保存 GB、カスタムメトリクス数 | ログ取り込み: $0.50/GB、メトリクス: 最初の 10k メトリクスは無料、その後段階的料金 | AWS 料金ページ参照 |

EC2 エージェントの場合、予測可能なワークロードに対してリザーブドインスタンスまたは Savings Plans を使用するとコストを削減できます。監視に基づいてインスタンスを適切なサイズにすることが不可欠です。エージェントに HA が厳密に必要ない場合 (DC には推奨されませんが)、エージェントと DC を同じ AZ に保持することで AZ 間コストを削減できますが、これは回復力とのトレードオフになります。26 はリザーブドインスタンス/Savings Plans と適切なサイジングについて言及しています。48 は AZ 間データ転送コストを強調しています。慎重なアーキテクチャの選択が継続的な運用経費に影響します。

**8\. 結論と戦略的推奨事項**

Entra Cloud Sync は、Entra ID セキュリティグループを AWS ホスト型 AD (Managed AD または AD on EC2) にプロビジョニングするための、Microsoft がサポートする実行可能な方法を提供します。このソリューションの成功は、事前の綿密な計画と、Azure と AWS の両方の環境におけるベストプラクティスの遵守にかかっています。

主要な戦略的アドバイスは以下の通りです:

* **徹底的な計画:** AD の準備 (スキーマ、gMSA)、AWS ネットワークアーキテクチャ (VPC、サブネット、セキュリティグループ、NACL)、および Cloud Sync エージェントの展開 (EC2 サイジング、配置) は、実装前に詳細に計画する必要があります。  
* **セキュリティの優先:** 最小権限の原則 (AD の gMSA、EC2 の IAM ロール)、ネットワークセグメンテーション、エージェントサーバーの強化 (Tier 0 資産としての扱いを検討 10)、および監査ログの監視は、ハイブリッド環境のセキュリティを確保するために不可欠です。  
* **段階的な展開とテスト:** パイロット展開から開始し、オンデマンドプロビジョニング機能 3 を活用して、構成変更を広範囲に適用する前に徹底的にテストします。  
* **包括的な監視:** Azure (Entra ID プロビジョニングログ、エージェントの正常性) と AWS (CloudWatch メトリクスとログ、EC2 インスタンスのパフォーマンス) の両方で監視ソリューションを実装し、運用上の可視性と問題の早期検出を確保します。Azure Arc for servers 45 を活用して、ハイブリッド監視を統合することを検討してください。  
* **コストの評価:** Microsoft Entra ID ライセンス (P1 が必須 4) および関連する AWS サービス (EC2、データ転送、AWS Managed Microsoft AD、NAT ゲートウェイなど) のコストを慎重に評価し、予算に計上します。  
* **制限事項の認識:** Cloud Sync の現在の制限事項 (例: Microsoft 365 グループの直接書き戻しはこの機能ではサポートされておらず、Entra Connect Sync v1 が依然として必要 4) を認識し、必要に応じて Entra Connect Sync を並行して使用するか、Cloud Sync がすべてのハイブリッド要件を満たすかどうかを評価して、それに応じて計画します。

Entra Cloud Sync は進化し続けているソリューションであるため、新しい機能や機能について常に最新情報を入手することが重要です。本レポートで概説されているガイドラインと考慮事項に従うことで、組織は Entra ID と AWS 上の Active Directory 環境との間で ID データを安全かつ効率的に同期するための堅牢なソリューションを実装できます。

#### **引用文献**

1. What is Microsoft Entra Cloud Sync? \- Microsoft Entra ID | Microsoft ..., 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/what-is-cloud-sync](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/what-is-cloud-sync)  
2. Microsoft Entra Cloud Sync Explained and Setup Guide \- Office365Concepts, 5月 22, 2025にアクセス、 [https://office365concepts.com/what-is-azure-ad-connect-cloud-sync/](https://office365concepts.com/what-is-azure-ad-connect-cloud-sync/)  
3. Configure \- Provisioning Microsoft Entra ID to Active Directory using ..., 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-configure-entra-to-active-directory](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-configure-entra-to-active-directory)  
4. Group writeback with Microsoft Entra Cloud Sync, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/group-writeback-cloud-sync](https://learn.microsoft.com/en-us/entra/identity/hybrid/group-writeback-cloud-sync)  
5. AWS Managed Microsoft AD のアプリケーションの互換性 \- AWS ..., 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/ja\_jp/directoryservice/latest/admin-guide/ms\_ad\_app\_compatibility.html](https://docs.aws.amazon.com/ja_jp/directoryservice/latest/admin-guide/ms_ad_app_compatibility.html)  
6. AWS Managed Microsoft AD best practices \- AWS Directory Service, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_best\_practices.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_best_practices.html)  
7. How to Connect Your On-Premises Active Directory to AWS Using ..., 5月 22, 2025にアクセス、 [https://aws.amazon.com/blogs/security/how-to-connect-your-on-premises-active-directory-to-aws-using-ad-connector/](https://aws.amazon.com/blogs/security/how-to-connect-your-on-premises-active-directory-to-aws-using-ad-connector/)  
8. AWS Managed Microsoft AD を に接続する Microsoft Entra Connect ..., 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/ja\_jp/directoryservice/latest/admin-guide/ms\_ad\_connect\_ms\_entra\_sync.html](https://docs.aws.amazon.com/ja_jp/directoryservice/latest/admin-guide/ms_ad_connect_ms_entra_sync.html)  
9. Design considerations for running Active Directory on EC2 instances \- AWS Documentation, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/whitepapers/latest/active-directory-domain-services/design-considerations-for-running-active-directory-on-ec2-instances.html](https://docs.aws.amazon.com/whitepapers/latest/active-directory-domain-services/design-considerations-for-running-active-directory-on-ec2-instances.html)  
10. Prerequisites for Microsoft Entra Cloud Sync in Microsoft Entra ID ..., 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-prerequisites](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-prerequisites)  
11. Microsoft Entra Plans and Pricing | Microsoft Security, 5月 22, 2025にアクセス、 [https://www.microsoft.com/en-us/security/business/microsoft-entra-pricing](https://www.microsoft.com/en-us/security/business/microsoft-entra-pricing)  
12. Tutorial \- Provision groups to Active Directory using Microsoft Entra Cloud Sync, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/tutorial-group-provisioning](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/tutorial-group-provisioning)  
13. Microsoft Entra Cloud Sync の前提条件 \- Learn Microsoft, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/ja-jp/entra/identity/hybrid/cloud-sync/how-to-prerequisites](https://learn.microsoft.com/ja-jp/entra/identity/hybrid/cloud-sync/how-to-prerequisites)  
14. Installing Microsoft Entra Cloud Sync | Zero Trust Lab Guide, 5月 22, 2025にアクセス、 [https://microsoft.github.io/ztlabguide/cloudsync/](https://microsoft.github.io/ztlabguide/cloudsync/)  
15. Install the Microsoft Entra provisioning agent, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-install](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-install)  
16. Group Writeback with Microsoft Entra Cloud Sync | Practical365, 5月 22, 2025にアクセス、 [https://practical365.com/group-writeback-with-microsoft-entra-cloud-sync/](https://practical365.com/group-writeback-with-microsoft-entra-cloud-sync/)  
17. Microsoft Entra Cloud Sync deep dive \- how it works, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/concept-how-it-works](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/concept-how-it-works)  
18. Designing private network connectivity between AWS and Microsoft Azure, 5月 22, 2025にアクセス、 [https://aws.amazon.com/blogs/modernizing-with-aws/designing-private-network-connectivity-aws-azure/](https://aws.amazon.com/blogs/modernizing-with-aws/designing-private-network-connectivity-aws-azure/)  
19. Using AWS Directory Service for Entra ID Domain Services \- AWS Transfer Family, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/transfer/latest/userguide/azure-sftp.html](https://docs.aws.amazon.com/transfer/latest/userguide/azure-sftp.html)  
20. Cloud sync troubleshooting \- Microsoft Entra ID, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-troubleshoot](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-troubleshoot)  
21. How to Choose the Right Amazon EC2 Instance Type | Watch Now \- Densify, 5月 22, 2025にアクセス、 [https://www.densify.com/resources/ec2-instance-types/](https://www.densify.com/resources/ec2-instance-types/)  
22. Amazon EC2 Instance Types \- Compute \- AWS, 5月 22, 2025にアクセス、 [https://aws.amazon.com/ec2/instance-types/](https://aws.amazon.com/ec2/instance-types/)  
23. Monitoring Windows services with Amazon CloudWatch | AWS Cloud Operations Blog, 5月 22, 2025にアクセス、 [https://aws.amazon.com/blogs/mt/monitoring-windows-services-with-amazon-cloudwatch-2/](https://aws.amazon.com/blogs/mt/monitoring-windows-services-with-amazon-cloudwatch-2/)  
24. How to Monitor EC2 with CloudWatch \- AWS for Engineers, 5月 22, 2025にアクセス、 [https://awsforengineers.com/blog/how-to-monitor-ec2-with-cloudwatch/](https://awsforengineers.com/blog/how-to-monitor-ec2-with-cloudwatch/)  
25. Select the appropriate EC2 instance type for your workload \- AWS re:Post, 5月 22, 2025にアクセス、 [https://repost.aws/knowledge-center/ec2-instance-choose-type-for-workload](https://repost.aws/knowledge-center/ec2-instance-choose-type-for-workload)  
26. Tips for Right Sizing \- Right Sizing: Provisioning Instances to Match Workloads \- AWS Documentation, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/whitepapers/latest/cost-optimization-right-sizing/tips-for-right-sizing-your-workloads.html](https://docs.aws.amazon.com/whitepapers/latest/cost-optimization-right-sizing/tips-for-right-sizing-your-workloads.html)  
27. Create IAM roles and users for use with the CloudWatch agent \- AWS Documentation \- Amazon.com, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/create-iam-roles-for-cloudwatch-agent.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/create-iam-roles-for-cloudwatch-agent.html)  
28. Joining an Amazon EC2 Windows instance to your AWS Managed Microsoft AD Active Directory, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/launching\_instance.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/launching_instance.html)  
29. Seamlessly joining an Amazon EC2 Linux instance to a shared AWS Managed Microsoft AD \- AWS Directory Service \- AWS Documentation, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/seamlessly\_join\_linux\_to\_shared\_MAD.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/seamlessly_join_linux_to_shared_MAD.html)  
30. User and group management in AWS Managed Microsoft AD \- AWS Directory Service, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_manage\_users\_groups.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_manage_users_groups.html)  
31. Seamlessly joining an Amazon EC2 Linux instance to your AWS Managed Microsoft AD Active Directory, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/seamlessly\_join\_linux\_instance.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/seamlessly_join_linux_instance.html)  
32. AWS Managed Account not updating after Microsoft Entra Connect Sync was installed, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/answers/questions/2154368/aws-managed-account-not-updating-after-microsoft-e](https://learn.microsoft.com/en-us/answers/questions/2154368/aws-managed-account-not-updating-after-microsoft-e)  
33. Connecting your AWS Managed Microsoft AD to Microsoft Entra Connect Sync \- AWS Directory Service \- AWS Documentation, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_connect\_ms\_entra\_sync.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_connect_ms_entra_sync.html)  
34. AWS Directory Service Pricing, 5月 22, 2025にアクセス、 [https://aws.amazon.com/directoryservice/pricing/](https://aws.amazon.com/directoryservice/pricing/)  
35. Microsoft Entra Cloud Sync の新しいエージェント構成 \- Microsoft ..., 5月 22, 2025にアクセス、 [https://learn.microsoft.com/ja-jp/entra/identity/hybrid/cloud-sync/how-to-configure](https://learn.microsoft.com/ja-jp/entra/identity/hybrid/cloud-sync/how-to-configure)  
36. Microsoft Entra Cloud Sync new agent configuration \- Microsoft Entra ID | Microsoft Learn, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-configure](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-configure)  
37. Synchronizing On-Prem AD with Microsoft Entra ID and Handling Duplicate Users, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/answers/questions/2262202/synchronizing-on-prem-ad-with-microsoft-entra-id-a](https://learn.microsoft.com/en-us/answers/questions/2262202/synchronizing-on-prem-ad-with-microsoft-entra-id-a)  
38. How do I sync my users from EntraID to my local Active Directory test domain using Cloud Connect. \- Learn Microsoft, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-au/answers/questions/2140357/how-do-i-sync-my-users-from-entraid-to-my-local-ac](https://learn.microsoft.com/en-au/answers/questions/2140357/how-do-i-sync-my-users-from-entraid-to-my-local-ac)  
39. On-demand provisioning \- Microsoft Entra ID to Active Directory, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-on-demand-provision-entra-to-active-directory](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-on-demand-provision-entra-to-active-directory)  
40. How do I configure Entra Cloud Sync to add another domain? \- Learn Microsoft, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/answers/questions/2225286/how-do-i-configure-entra-cloud-sync-to-add-another](https://learn.microsoft.com/en-us/answers/questions/2225286/how-do-i-configure-entra-cloud-sync-to-add-another)  
41. Group writeback for Microsoft 365 groups \- Microsoft Entra ID, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-group-writeback-enable](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-group-writeback-enable)  
42. Integrated Windows Authentication for Entra ID joined computers | VisualSVN Help Center, 5月 22, 2025にアクセス、 [https://www.visualsvn.com/support/topic/00240/](https://www.visualsvn.com/support/topic/00240/)  
43. Customer-managed process for configuring Kerberos authentication on an Amazon RDS for SQL Server DB instance, joined to a self-managed Active Directory | AWS Database Blog, 5月 22, 2025にアクセス、 [https://aws.amazon.com/blogs/database/customer-managed-process-for-configuring-kerberos-authentication-on-an-amazon-rds-for-sql-server-db-instance-joined-to-a-self-managed-active-directory/](https://aws.amazon.com/blogs/database/customer-managed-process-for-configuring-kerberos-authentication-on-an-amazon-rds-for-sql-server-db-instance-joined-to-a-self-managed-active-directory/)  
44. Implement password hash synchronization with Microsoft Entra ..., 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-password-hash-synchronization](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-password-hash-synchronization)  
45. Multicloud monitoring with Azure Monitor \- Learn Microsoft, 5月 22, 2025にアクセス、 [https://learn.microsoft.com/en-us/azure/azure-monitor/fundamentals/best-practices-multicloud](https://learn.microsoft.com/en-us/azure/azure-monitor/fundamentals/best-practices-multicloud)  
46. Troubleshooting AWS Managed Microsoft AD \- AWS Directory Service \- AWS Documentation, 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_troubleshooting.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_troubleshooting.html)  
47. EC2 On-Demand Instance Pricing – Amazon Web Services, 5月 22, 2025にアクセス、 [https://aws.amazon.com/ec2/pricing/on-demand/](https://aws.amazon.com/ec2/pricing/on-demand/)  
48. AWS Data Transfer Pricing: Solving Hidden Network Transfer Costs | NetApp, 5月 22, 2025にアクセス、 [https://www.netapp.com/learn/aws-cvo-blg-aws-data-transfer-costs-solving-hidden-network-transfer-costs/](https://www.netapp.com/learn/aws-cvo-blg-aws-data-transfer-costs-solving-hidden-network-transfer-costs/)  
49. AWS Data Transfer Pricing & Saving | CloudBolt Software, 5月 22, 2025にアクセス、 [https://www.cloudbolt.io/guide-to-aws-cost-optimization/aws-data-transfer-pricing/](https://www.cloudbolt.io/guide-to-aws-cost-optimization/aws-data-transfer-pricing/)  
50. How to reduce Data Transfer costs with EC2 and S3 | AWS re:Post, 5月 22, 2025にアクセス、 [https://repost.aws/questions/QUGtUOCTZTQo-AICZ\_eDJMxQ/how-to-reduce-data-transfer-costs-with-ec2-and-s3](https://repost.aws/questions/QUGtUOCTZTQo-AICZ_eDJMxQ/how-to-reduce-data-transfer-costs-with-ec2-and-s3)  
51. Scenario 5: AWS Microsoft AD using a shared services Virtual Private Cloud (VPC), 5月 22, 2025にアクセス、 [https://docs.aws.amazon.com/whitepapers/latest/best-practices-deploying-amazon-workspaces/scenario-5-aws-microsoft-ad-using-a-shared-services-virtual-private-cloud-vpc.html](https://docs.aws.amazon.com/whitepapers/latest/best-practices-deploying-amazon-workspaces/scenario-5-aws-microsoft-ad-using-a-shared-services-virtual-private-cloud-vpc.html)